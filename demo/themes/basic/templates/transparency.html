<!-- Basic Theme Transparency Report -->
<div class="transparency-report">
    <div class="report-header">
        <h2>Source Transparency</h2>
        <div class="report-meta">
            <span>Edition: {{ run_id }}</span>
            <span>Generated: {{ timestamp }}</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-link active" onclick="switchTab(event, 'tab-vitals')">Vitals</button>
        <button class="tab-link" onclick="switchTab(event, 'tab-sources')">Source Efficiency</button>
        <button class="tab-link" onclick="switchTab(event, 'tab-bubble')">The Bubble</button>
    </div>

    <!-- Tab Content: Vitals -->
    <div id="tab-vitals" class="tab-pane active" style="display: block;">
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value">{{ stats_input }}</span>
                <span class="stat-label">Total Items Scanned</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ stats_pool }}</span>
                <span class="stat-label">Fresh Candidates</span>
            </div>
            <div class="stat-card">
                <span class="stat-value">{{ stats_selected }}</span>
                <span class="stat-label">Published</span>
            </div>
            <div class="stat-card highlight">
                <span class="stat-value">{{ "%.1f"|format(anti_feed_protection) }}%</span>
                <span class="stat-label">Anti-Feed Protection</span>
                <small class="stat-sub">(Total - Published) / Total</small>
            </div>
        </div>
    </div>

    <!-- Tab Content: Sources -->
    <div id="tab-sources" class="tab-pane" style="display: none;">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Input Share</th>
                        <th>Output Share</th>
                        <th>Delta</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in source_velocity %}
                    <tr>
                        <td class="source-name">{{ row.domain }}</td>
                        <td>
                            {{ "%.1f"|format(row.input_pct) }}%
                            <span class="count-pill">{{ row.input_count }}</span>
                        </td>
                        <td>
                            {{ "%.1f"|format(row.output_pct) }}%
                            <span class="count-pill">{{ row.output_count }}</span>
                        </td>
                        <td>
                            {% if row.delta > 0 %}
                            <span class="delta-pos">+{{ "%.1f"|format(row.delta) }}%</span>
                            {% elif row.delta < 0 %}
                            <span class="delta-neg">{{ "%.1f"|format(row.delta) }}%</span>
                            {% else %}
                            <span class="delta-neutral">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tab Content: The Bubble -->
    <div id="tab-bubble" class="tab-pane" style="display: none;">
        <p class="bubble-intro">Comparing the lowest-scoring articles that made the cut versus the highest-scoring ones that missed it.</p>
        
        {% for section, data in bubble.items() %}
        <div class="bubble-group">
            <h3 class="bubble-section-title">{{ section_map.get(section, section)|title }}</h3>
            <div class="bubble-columns">
                <!-- In -->
                <div class="bubble-col in">
                    <h4>Last In (Lowest Score)</h4>
                    <ul>
                        {% for item in data.in %}
                        <li>
                            <span class="score-badge">{{ "%.0f"|format(item.impact_score) }}</span>
                            {{ item.title }}
                        </li>
                        {% else %}
                        <li><em class="empty">None</em></li>
                        {% endfor %}
                    </ul>
                </div>
                <!-- Out -->
                <div class="bubble-col out">
                    <h4>First Out (Highest Score)</h4>
                    <ul>
                        {% for item in data.out %}
                        <li>
                            <span class="score-badge">{{ "%.0f"|format(item.impact_score) }}</span>
                            {{ item.title }}
                        </li>
                        {% else %}
                        <li><em class="empty">None</em></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function switchTab(evt, tabName) {
    var i, tabcontent, tablinks;
    
    tabcontent = document.getElementsByClassName("tab-pane");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
        tabcontent[i].classList.remove("active");
    }
    
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    
    document.getElementById(tabName).style.display = "block";
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}
</script>