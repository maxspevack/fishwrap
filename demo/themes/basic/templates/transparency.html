<div class="glass-box-container">
    <div class="audit-header">
        <h1>Source Transparency</h1>
        <p>Audit Log for Edition: <strong>{{ run_id }}</strong></p>
        <p>Generated: {{ timestamp }}</p>
    </div>

    <!-- The Funnel -->
    <div class="funnel-container">
        <div class="funnel-step">
            <span class="funnel-num">{{ stats_input }}</span>
            <small>Total Items</small>
        </div>
        <div class="funnel-step">
            <span class="funnel-num">{{ stats_pool }}</span>
            <small>Candidate Pool</small>
        </div>
        <div class="funnel-step">
            <span class="funnel-num">{{ stats_selected }}</span>
            <small>Published</small>
        </div>
        <div class="funnel-step">
            <span class="funnel-num">{{ "%.1f"|format(yield_rate) }}%</span>
            <small>Signal Ratio</small>
            <span class="funnel-sub">(Published / Total)</span>
            <span class="funnel-sub">Filtered: {{ filtered_count }}</span>
        </div>
    </div>

    <!-- Source Efficiency -->
    <h2>Source Efficiency</h2>
    <p>
        <em>
            A <span class="bias-pos">positive Delta (+)</span> means <strong>High Signal</strong>: We publish this source more often than we find it.<br>
            A <span class="bias-neg">negative Delta (-)</span> means <strong>High Noise</strong>: We filter (but do not silence) this source aggressively.
        </em>
    </p>
    
    <table class="audit-table">
        <thead>
            <tr>
                <th>Source</th>
                <th>Output Share (Count)</th>
                <th>Input Share (Count)</th>
                <th>Delta</th>
            </tr>
        </thead>
        <tbody>
            {% for row in source_velocity %}
            <tr>
                <td>{{ row.domain }}</td>
                <td>
                    {{ "%.1f"|format(row.output_pct) }}%
                    <span class="count-sub">({{ row.output_count }})</span>
                </td>
                <td>
                    {{ "%.1f"|format(row.input_pct) }}%
                    <span class="count-sub">({{ row.input_count }})</span>
                </td>
                <td>
                    {% if row.delta > 0 %}
                    <span class="bias-pos">+{{ "%.1f"|format(row.delta) }}%</span>
                    {% elif row.delta < 0 %}
                    <span class="bias-neg">{{ "%.1f"|format(row.delta) }}%</span>
                    {% else %}
                    0.0%
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- The Bubble -->
    <h2>The Bubble</h2>
    <p><em>Comparing the last stories to make the cut vs. the first to miss it.</em></p>
    
    {% for section, data in bubble.items() %}
    <div class="bubble-section">
        <h3>{{ section }}</h3>
        <div class="bubble-grid">
            <!-- Last 3 In -->
            <div class="bubble-col bubble-in">
                <div class="bubble-header">Last 3 In (Lowest Scores)</div>
                {% for item in data.in %}
                <div class="bubble-item">
                    <span class="score-badge">{{ "%.0f"|format(item.impact_score) }}</span>
                    <span>{{ item.title }}</span>
                </div>
                {% else %}
                <div class="bubble-item">No articles selected.</div>
                {% endfor %}
            </div>
            
            <!-- First 3 Out -->
            <div class="bubble-col bubble-out">
                <div class="bubble-header">First 3 Out (Highest Scores)</div>
                {% for item in data.out %}
                <div class="bubble-item">
                    <span class="score-badge">{{ "%.0f"|format(item.impact_score) }}</span>
                    <span>{{ item.title }}</span>
                </div>
                {% else %}
                <div class="bubble-item">No bubble (Capacity not met).</div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>