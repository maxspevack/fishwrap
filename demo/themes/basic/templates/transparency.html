<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transparency Report - {{ date_str }}</title>
    <link rel="stylesheet" href="static/css/style.css">
    <style>
        /* Transparency Specific Overrides */
        body { max-width: 900px; margin: 0 auto; padding: 2rem; }
        .audit-header { border-bottom: 2px solid #000; padding-bottom: 1rem; margin-bottom: 2rem; }
        .funnel-container { display: flex; justify-content: space-between; background: #eee; padding: 1rem; margin-bottom: 2rem; }
        .funnel-step { text-align: center; }
        .funnel-num { font-size: 1.5rem; font-weight: bold; display: block; }
        
        table.audit-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; font-size: 0.9rem; }
        th { text-align: left; border-bottom: 2px solid #000; padding: 0.5rem; }
        td { border-bottom: 1px solid #ccc; padding: 0.5rem; }
        .bias-pos { color: green; font-weight: bold; }
        .bias-neg { color: red; font-weight: bold; }
        .count-sub { color: #666; font-size: 0.8em; margin-left: 4px; }
        
        /* Bubble Styles */
        .bubble-section { margin-bottom: 2rem; border-top: 1px solid #eee; padding-top: 1rem; }
        .bubble-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .bubble-col { padding: 1rem; border-radius: 4px; }
        .bubble-in { background: #f0fff0; border-left: 4px solid green; }
        .bubble-out { background: #fff0f0; border-left: 4px solid red; }
        .bubble-header { font-weight: bold; text-transform: uppercase; margin-bottom: 0.5rem; font-size: 0.8rem; letter-spacing: 1px; }
        
        .bubble-item { margin-bottom: 0.5rem; font-family: monospace; font-size: 0.85rem; display: flex; align-items: baseline; }
        .score-badge { 
            display: inline-block; width: 50px; flex-shrink: 0; font-weight: bold; text-align: right; margin-right: 10px; 
        }
        
        @media (max-width: 600px) {
            .bubble-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="audit-header">
        <h1>Transparency Report</h1>
        <p>Audit Log for Edition: <strong>{{ run_id }}</strong></p>
        <p>Generated: {{ timestamp }}</p>
    </div>

    <!-- The Funnel -->
    <div class="funnel-container">
        <div class="funnel-step">
            <span class="funnel-num">{{ stats_input }}</span>
            <small>Total Items</small>
        </div>
        <div class="funnel-step">
            <span class="funnel-num">{{ stats_pool }}</span>
            <small>Pool</small>
        </div>
        <div class="funnel-step">
            <span class="funnel-num">{{ stats_selected }}</span>
            <small>Selection</small>
        </div>
        <div class="funnel-step">
            <span class="funnel-num">{{ "%.1f"|format(yield_rate) }}%</span>
            <small>Yield Rate</small>
        </div>
    </div>

    <!-- Source Efficiency (Input vs Output) -->
    <h2>Source Efficiency</h2>
    <p>
        <em>
            A positive Delta (+) means <strong>High Signal</strong>: We publish this source more often than we find it.<br>
            A negative Delta (-) means <strong>High Noise</strong>: We filter (but do not silence) this source aggressively.
        </em>
    </p>
    
    <table class="audit-table">
        <thead>
            <tr>
                <th>Source</th>
                <th>Output Share (Count)</th>
                <th>Input Share (Count)</th>
                <th>Delta</th>
            </tr>
        </thead>
        <tbody>
            {% for row in source_velocity %}
            <tr>
                <td>{{ row.domain }}</td>
                <td>
                    {{ "%.1f"|format(row.output_pct) }}%
                    <span class="count-sub">({{ row.output_count }})</span>
                </td>
                <td>
                    {{ "%.1f"|format(row.input_pct) }}%
                    <span class="count-sub">({{ row.input_count }})</span>
                </td>
                <td>
                    {% if row.delta > 0 %}
                    <span class="bias-pos">+{{ "%.1f"|format(row.delta) }}%</span>
                    {% elif row.delta < 0 %}
                    <span class="bias-neg">{{ "%.1f"|format(row.delta) }}%</span>
                    {% else %}
                    0.0%
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- The Bubble -->
    <h2>The Bubble</h2>
    <p><em>Comparing the last stories to make the cut vs. the first to miss it.</em></p>
    
    {% for section, data in bubble.items() %}
    <div class="bubble-section">
        <h3>{{ section }}</h3>
        <div class="bubble-grid">
            <!-- Last 3 In -->
            <div class="bubble-col bubble-in">
                <div class="bubble-header">Last 3 In (Lowest Scores)</div>
                {% for item in data.in %}
                <div class="bubble-item">
                    <span class="score-badge">{{ "%.0f"|format(item.impact_score) }}</span>
                    <span>{{ item.title }}</span>
                </div>
                {% else %}
                <div class="bubble-item">No articles selected.</div>
                {% endfor %}
            </div>
            
            <!-- First 3 Out -->
            <div class="bubble-col bubble-out">
                <div class="bubble-header">First 3 Out (Highest Scores)</div>
                {% for item in data.out %}
                <div class="bubble-item">
                    <span class="score-badge">{{ "%.0f"|format(item.impact_score) }}</span>
                    <span>{{ item.title }}</span>
                </div>
                {% else %}
                <div class="bubble-item">No bubble (Capacity not met).</div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}

    <footer style="margin-top: 4rem; border-top: 1px solid #ccc; padding-top: 1rem; text-align: center;">
        <a href="index.html">&larr; Back to The Edition</a>
    </footer>

</body>
</html>
